<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Controller</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
        #status { margin-top: 20px; font-size: 18px; }
    </style>
</head>
<body>
    <img src="/stream" alt="Webcam Stream" />
    <h1>Tank Steering Robot Controller</h1>
    <p>Use <strong>WASD</strong> to drive. Hold <strong>Enter</strong> to go faster, <strong>Right Shift</strong> to go slower.</p>
    <div id="status">Status: Waiting for input...</div>

    <script>
        let baseSpeed = 2; // Default speed (normalized to range -1 to 1)
        let maxMultiplier = 2;  // Multiplier for Enter (faster)
        let minMultiplier = 0.5; // Multiplier for Right Shift (slower)
        let leftSpeed = 0;
        let rightSpeed = 0;
        let speedMultiplier = 1; // Default multiplier
        let throttleInterval = 200; // Interval in milliseconds for sending commands
        let lastSentTime = 0; // Timestamp of the last sent command

        const statusDiv = document.getElementById('status');

        // Key state tracking
        const keys = { w: false, a: false, s: false, d: false, enter: false, shift: false };

        // Update speeds based on key states
        function updateSpeeds() {
            speedMultiplier = 1; // Reset multiplier
            if (keys.enter) speedMultiplier = maxMultiplier; // Enter increases speed
            if (keys.shift) speedMultiplier = minMultiplier; // Right Shift decreases speed

            if (keys.w && keys.a) {
                leftSpeed = baseSpeed * 0.5;
                rightSpeed = baseSpeed;
            } else if (keys.w && keys.d) {
                leftSpeed = baseSpeed;
                rightSpeed = baseSpeed * 0.5;
            } else if (keys.s && keys.a) {
                leftSpeed = -baseSpeed * 0.5;
                rightSpeed = -baseSpeed;
            } else if (keys.s && keys.d) {
                leftSpeed = -baseSpeed;
                rightSpeed = -baseSpeed * 0.5;
            } else if (keys.w) {
                leftSpeed = baseSpeed;
                rightSpeed = baseSpeed;
            } else if (keys.s) {
                leftSpeed = -baseSpeed;
                rightSpeed = -baseSpeed;
            } else if (keys.a) {
                leftSpeed = -baseSpeed;
                rightSpeed = baseSpeed;
            } else if (keys.d) {
                leftSpeed = baseSpeed;
                rightSpeed = -baseSpeed;
            } else {
                leftSpeed = 0;
                rightSpeed = 0;
            }

            // Throttle sending commands
            const currentTime = Date.now();
            if (currentTime - lastSentTime >= throttleInterval) {
                sendCommand(leftSpeed, rightSpeed, speedMultiplier);
                lastSentTime = currentTime;
            }
        }

        // Send command to the server
        async function sendCommand(leftSpeed, rightSpeed, speedMultiplier) {
            try {
                const response = await fetch('/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ leftSpeed, rightSpeed, speedMultiplier })
                });
                const result = await response.text();
                statusDiv.textContent = `Status: ${result}`;
            } catch (error) {
                console.error('Error:', error);
                statusDiv.textContent = 'Status: Failed to send command';
            }
        }

        // Handle keydown and keyup events
        document.addEventListener('keydown', (event) => {
            const key = event.key.toLowerCase();
            if (key === 'enter') {
                keys.enter = true;
            } else if (key === 'shift' && event.code === 'ShiftRight') {
                keys.shift = true; // Only track Right Shift
            } else if (keys[key] !== undefined) {
                keys[key] = true;
            }
            updateSpeeds();
        });

        document.addEventListener('keyup', (event) => {
            const key = event.key.toLowerCase();
            if (key === 'enter') {
                keys.enter = false;
            } else if (key === 'shift' && event.code === 'ShiftRight') {
                keys.shift = false; // Only track Right Shift
            } else if (keys[key] !== undefined) {
                keys[key] = false;
            }
            updateSpeeds();
        });
    </script>
</body>
</html>